---
title: "WHAM_Run29_splitNEFSC"
output: html_document
date: '2022-03-22'
---

## Model description
Full state-space model as in run 27 (revised data, fixed selectivity at intermediate ages, logistic fleet selectivity, age-specific index selectivity, with an iid random effect for selectivity, recruitment that is random about the mean), with NEFSC bottom trawl surveys split into Albatross (1980-2008, indices 1 and 3 for spring/fall) and Bigelow (2009-2019, indices 2 and 4 for spring/fall) timeseries. 

### Load R packages
```{r, echo=FALSE}
library(tidyverse)
library(wham)
library(readxl)
library(DataExplorer)
```

### Load data
```{r}
asap3 <- read_asap3_dat(paste(here::here(), "data", "PlaiceWHAM-2019_revised_NEFSC-LW-WAA_splitNEFSC.DAT", sep="/"))
```

### Prepare model input
```{r}
# iid random effects for recruitment only 
NAA_re = list(sigma = "rec+1") # Full state-space model
NAA_re$cor = "iid" # iid random effects
NAA_re$recruit_model = 2 # recruitment is random about the mean
NAA_re$recruit_pars = exp(10) #initial guess for mean recruitment

# Setup initial selectivity model and parameters
use_n_indices = 4
modelsetup <- c(rep("logistic", asap3$dat$n_fleet_sel_blocks), rep("age-specific", use_n_indices))

init_fleet_sel <- list(c(2,0.4)) # logistic parameters, based on model type
init_index_sel <- lapply(1:use_n_indices, function(x) c(0.5, 0.5, 0.5, 1, 1, 0.5, 0.5, 0.5, 0.5, 0.5, 0.5))

# Setup fixed parameters
fix_fleet_sel <- lapply(1:asap3$dat$n_fleets, function(x) NA) 
fix_index_sel <- lapply(1:use_n_indices, function(x) NA) # Set up index object

fix_index_sel[[1]] <- c(4,5) # Fix age 4 & 5 for for index 1 (NEFSC spring Albatross)
fix_index_sel[[2]] <- c(4,5) # Fix age 4 & 5 for for index 2 (NEFSC spring Bigelow)
fix_index_sel[[3]][1] <- 4 # Fix age 4 for for index 2 (NEFSC fall Albatross)

fix_index_sel[[4]][1] <- 4 # Fix age 4 for for index 2 (NEFSC fall Bigelow)

# Setup random effect by selectivity block (here: fleet, index1, index2)
randeffect <- c(rep("iid", asap3$dat$n_fleet_sel_blocks), rep("iid", use_n_indices))

# Setup selectivity list
sel_list <- list(model = modelsetup, # list selectivity model for each fleet and index
                 re = randeffect,
                 initial_pars = c(init_fleet_sel, init_index_sel),
                 fix_pars = c(fix_fleet_sel, fix_index_sel))

input <- prepare_wham_input(asap3, NAA_re = NAA_re, selectivity = sel_list, model_name = "WHAM_Run29") 
```

### Save input
```{r}
# Save model data input
saveRDS(input, file=paste(here::here(), "WG_Revised_Runs", "WHAM_Run29_splitNEFSC", "WHAM_Run29_input.rds", sep="/"))
```

### Fit model, check convergence, and run diagnostics
```{r}
WHAM_Run29 <- fit_wham(input, do.osa=F,do.retro=F) 
WHAM_Run29 <- fit_wham(input, MakeADFun.silent = TRUE) 
check_convergence(WHAM_Run29)
WHAM_Run29$parList$sel_repars #variance of selectivity random effects -> 0 for (last 3) surveys except first (Albatross Spring?) 
# I suspect that the increased flexibility in the random effects for numbers at age negates the need for selectivity RE for these surveys. So, perhaps try removing the selectivity re for at least the last 3 surveys.
print(paste("Number of parameters", length(WHAM_Run29$par), sep=" "))

plot_wham_output(mod=WHAM_Run29, out.type='html')
# plot_wham_output(mod=WHAM_Run29, out.type='png', dir.main = paste(here::here(), "WHAM_Run29", sep="/"))
```

### Debug
```{r}
# debug NA/NaN
WHAM_Run29 <- fit_wham(input, do.fit=F)
therep = WHAM_Run29$report()
names(therep)
sapply(grep("nll",names(therep),value=T), function(x) sum(therep[[x]]))

# Look at parameter estimates
WHAM_Run29$sdrep
```

### Save output
```{r}
# Save fitted model
saveRDS(WHAM_Run29, file=paste(here::here(), "WG_Revised_Runs", "WHAM_Run29_splitNEFSC", "WHAM_Run29_model.rds", sep="/"))
```

### Rerun model using saved input data
Load data from saved input RData and rerun model
```{r}
inputRerun <- readRDS(paste(here::here(), "WG_Revised_Runs",
                     "WHAM_Run29_splitNEFSC/WHAM_Run29_input.rds", sep="/"))

# Rerun data
ReRun29 <- fit_wham(input = inputRerun, MakeADFun.silent = TRUE)
```

## Comment
Model converged but the hessian wasn't invertible. This appears to be an issue with a couple of the selectivity parameters.

WHAM_Run29$sdrep shows NaN in logit_selpars (year 14 for fleet, try fixing selectivity for age 11+ to 1)
